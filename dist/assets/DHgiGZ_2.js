import{s}from"./BuWSaeZB.js";const d={async getFeed(r=20,e=0){const{data:t,error:a}=await s.from("posts").select(`
        *,
        user:profiles!posts_user_id_fkey(id, username, avatar_url, avatar_color, level, league),
        opponent:profiles!posts_opponent_id_fkey(id, username, avatar_url, avatar_color)
      `).eq("is_public",!0).order("created_at",{ascending:!1}).range(e,e+r-1);if(a)throw a;return t||[]},async getUserFeed(r,e=20){const{data:t,error:a}=await s.from("posts").select(`
        *,
        user:profiles!posts_user_id_fkey(id, username, avatar_url, avatar_color, level, league),
        opponent:profiles!posts_opponent_id_fkey(id, username, avatar_url, avatar_color)
      `).eq("user_id",r).order("created_at",{ascending:!1}).limit(e);if(a)throw a;return t||[]},async postQuizResult(r,e,t,a,o,i){const{data:l,error:n}=await s.from("posts").insert({user_id:r,type:"result",category:e,score:t,is_victory:a,opponent_id:o,opponent_score:i}).select().single();if(n)throw n;return l},async postAchievement(r,e){const{data:t,error:a}=await s.from("posts").insert({user_id:r,type:"achievement",achievement_id:e}).select().single();if(a)throw a;return t},async postLevelUp(r,e){const{data:t,error:a}=await s.from("posts").insert({user_id:r,type:"level_up",new_level:e}).select().single();if(a)throw a;return t},async postLeagueUp(r,e){const{data:t,error:a}=await s.from("posts").insert({user_id:r,type:"league_up",new_league:e}).select().single();if(a)throw a;return t},async createChallenge(r,e,t="medium",a){const{data:o,error:i}=await s.from("challenges").insert({challenger_id:r,challenged_id:a,category:e,difficulty:t}).select().single();if(i)throw i;return await s.from("posts").insert({user_id:r,type:"challenge",challenge_category:e,challenge_difficulty:t}),o},async likePost(r,e){const{error:t}=await s.from("post_likes").insert({post_id:r,user_id:e});if(t&&!t.message.includes("duplicate"))throw t},async unlikePost(r,e){const{error:t}=await s.from("post_likes").delete().eq("post_id",r).eq("user_id",e);if(t)throw t},async isPostLiked(r,e){const{data:t}=await s.from("post_likes").select("id").eq("post_id",r).eq("user_id",e).single();return!!t},async getComments(r){const{data:e,error:t}=await s.from("post_comments").select(`
        *,
        user:profiles(id, username, avatar_url, avatar_color)
      `).eq("post_id",r).order("created_at",{ascending:!0});if(t)throw t;return e||[]},async addComment(r,e,t){const{data:a,error:o}=await s.from("post_comments").insert({post_id:r,user_id:e,content:t}).select(`
        *,
        user:profiles(id, username, avatar_url, avatar_color)
      `).single();if(o)throw o;return a},async deleteComment(r){const{error:e}=await s.from("post_comments").delete().eq("id",r);if(e)throw e}},_={async getNotifications(r,e=50){const{data:t,error:a}=await s.from("notifications").select(`
        *,
        from_user:profiles!notifications_from_user_id_fkey(id, username, avatar_url, avatar_color)
      `).eq("user_id",r).order("created_at",{ascending:!1}).limit(e);if(a)throw a;return t||[]},async getUnreadCount(r){const{count:e,error:t}=await s.from("notifications").select("*",{count:"exact",head:!0}).eq("user_id",r).eq("is_read",!1);if(t)throw t;return e||0},async markAsRead(r){const{error:e}=await s.from("notifications").update({is_read:!0}).eq("id",r);if(e)throw e},async markAllAsRead(r){const{error:e}=await s.from("notifications").update({is_read:!0}).eq("user_id",r).eq("is_read",!1);if(e)throw e},subscribeToNotifications(r,e){return s.channel(`notifications_${r}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${r}`},t=>e(t.new)).subscribe()}},u={async getPublicChallenges(r=20){const{data:e,error:t}=await s.from("challenges").select(`
        *,
        challenger:profiles!challenges_challenger_id_fkey(id, username, avatar_url, avatar_color, level)
      `).is("challenged_id",null).eq("status","pending").gt("expires_at",new Date().toISOString()).order("created_at",{ascending:!1}).limit(r);if(t)throw t;return e||[]},async acceptChallenge(r,e){const{error:t}=await s.from("challenges").update({challenged_id:e,status:"accepted"}).eq("id",r).is("challenged_id",null);if(t)throw t},async completeChallenge(r,e,t){const{data:a}=await s.from("challenges").select("challenger_id, challenged_id").eq("id",r).single();if(!a)return;const{error:o}=await s.from("challenges").update({status:"completed",challenger_score:e,challenged_score:t,winner_id:e>t?a.challenger_id:a.challenged_id,completed_at:new Date().toISOString()}).eq("id",r);if(o)throw o},async getMyChallenges(r){const{data:e,error:t}=await s.from("challenges").select(`
        *,
        challenger:profiles!challenges_challenger_id_fkey(id, username, avatar_url, avatar_color, level)
      `).or(`challenger_id.eq.${r},challenged_id.eq.${r}`).order("created_at",{ascending:!1});if(t)throw t;return e||[]}};export{u as c,d as f,_ as n};
